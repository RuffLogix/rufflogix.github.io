---
import FormalLayout from "../../layouts/FormalLayout.astro";

const MEDIUM_URL =
  "https://api.rss2json.com/v1/api.json?rss_url=https://medium.com/feed/@rufflogix";

interface MediumResponse {
  title: string;
  pubDate: string;
  link: string;
  guid: string;
  author: string;
  thumbnail: string;
  description: string;
}

interface MediumPost {
  title: string;
  date: string;
  link: string;
  author: string;
  thumbnail: string;
  excerpt: string;
}

function extractPostImage(postDescription: string) {
  const regex = /<img[^>]+src="([^">]+)"/;
  const match = postDescription.match(regex);
  return match ? match[1] : null;
}

function extractExcerpt(html: string, maxLength: number = 200): string {
  const text = html
    .replace(/<[^>]*>/g, "")
    .replace(/\s+/g, " ")
    .trim();
  return text.length > maxLength ? text.substring(0, maxLength) + "..." : text;
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}

async function getMediumPosts(): Promise<MediumPost[]> {
  const response = await fetch(MEDIUM_URL);
  const data = await response.json();
  const postResponse = data.items;

  const posts: MediumPost[] = postResponse.map((post: MediumResponse) => {
    const image = extractPostImage(post.description);
    return {
      title: post.title,
      date: post.pubDate,
      link: post.guid,
      author: post.author,
      thumbnail: image,
      excerpt: extractExcerpt(post.description),
    };
  });

  return posts;
}

const posts = await getMediumPosts();
---

<FormalLayout title="Posts | Teejuta Sriwaranon">
  <div
    class="formal-container"
    style="padding-top: 2rem; padding-bottom: 3rem;"
  >
    <header style="margin-bottom: 2rem;">
      <h1 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Posts</h1>
      <p style="color: var(--color-text-muted); font-size: 0.875rem;">
        Articles and thoughts from <a
          href="https://medium.com/@rufflogix"
          target="_blank"
          rel="noopener noreferrer">@rufflogix</a
        > on Medium
      </p>
    </header>

    <div class="formal-posts-list">
      {
        posts.length > 0 ? (
          posts.map((post) => (
            <article class="formal-post">
              <h3 class="formal-post-title">
                <a href={post.link} target="_blank" rel="noopener noreferrer">
                  {post.title}
                </a>
              </h3>
              <div class="formal-post-meta">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                  <line x1="16" y1="2" x2="16" y2="6" />
                  <line x1="8" y1="2" x2="8" y2="6" />
                  <line x1="3" y1="10" x2="21" y2="10" />
                </svg>
                <span>{formatDate(post.date)}</span>
              </div>
              <p class="formal-post-excerpt">{post.excerpt}</p>
            </article>
          ))
        ) : (
          <p style="color: var(--color-text-muted);">
            No posts available at the moment. Check back soon!
          </p>
        )
      }
    </div>
  </div>
</FormalLayout>

<style>
  .formal-posts-list {
    display: flex;
    flex-direction: column;
  }
</style>
